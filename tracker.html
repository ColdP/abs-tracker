<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>腹肌训练追踪 - 记录</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Google Fonts: Manrope -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Manrope:wght@400;700;800&display=swap" rel="stylesheet">
    <!-- Google Fonts Icons -->
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@20..48,100..700,0..1,-50..200" />
    <style>
        body { font-family: 'Manrope', sans-serif; }
        .m3-surface { background-color: #ffffff; border-radius: 1.75rem; box-shadow: 0 4px 12px rgba(0,0,0,0.05); }
        .m3-primary-text { color: #005ac1; }
        .m3-primary-bg { background-color: #d8e2ff; }
        .m3-primary-fill { background-color: #005ac1; }
        .m3-button {
            background-color: #005ac1;
            color: white;
            font-weight: bold;
            border-radius: 999px;
            padding: 0.75rem 1.5rem;
            transition: all 0.3s ease;
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
        }
        .m3-button:hover { background-color: #004a9b; box-shadow: 0 2px 8px rgba(0, 90, 193, 0.3); }
        .m3-button:disabled { background-color: #a5a5a5; cursor: not-allowed; }
        .set-button {
            width: 48px; height: 48px; border-radius: 50%;
            border: 2px solid #b0c4ff; color: #b0c4ff;
            display: flex; align-items: center; justify-content: center;
            font-weight: bold; transition: all 0.2s ease;
        }
        .set-button.completed { background-color: #005ac1; color: white; border-color: #005ac1; }
        .password-modal {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background-color: rgba(0, 0, 0, 0.6);
            display: flex; align-items: center; justify-content: center;
            z-index: 999; backdrop-filter: blur(5px);
        }
    </style>
</head>
<body class="bg-blue-50 text-gray-800">

    <!-- Password Modal -->
    <div id="password-modal" class="password-modal">
        <div class="m3-surface p-8 rounded-3xl w-11/12 max-w-sm text-center">
            <h2 class="text-2xl font-bold mb-4">请输入密码</h2>
            <p class="text-gray-500 mb-6">此页面受密码保护。</p>
            <input type="password" id="password-input" class="w-full px-4 py-3 border-2 border-gray-200 rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-blue-500 outline-none transition">
            <p id="password-error" class="text-red-500 h-5 mt-2 text-sm"></p>
            <button id="password-submit" class="m3-button w-full justify-center mt-4">进入</button>
        </div>
    </div>

    <div id="app-content" class="container mx-auto p-4 md:p-8 max-w-4xl hidden">
        <!-- Header -->
        <header class="flex justify-between items-center mb-8">
            <div>
                <h1 class="text-4xl font-extrabold m3-primary-text">记录今日训练</h1>
                <p id="today-date" class="text-gray-500 mt-1"></p>
            </div>
             <nav class="flex gap-2">
                <a href="./index.html" class="px-4 py-2 hover:bg-blue-100 rounded-full">状态</a>
                <a href="./tracker.html" class="px-4 py-2 m3-primary-bg text-blue-800 font-bold rounded-full">记录</a>
                <a href="./blog.html" class="px-4 py-2 hover:bg-blue-100 rounded-full">博客</a>
            </nav>
        </header>

        <main class="space-y-8">
            <!-- Exercises Tracker -->
            <div class="m3-surface p-6">
                <h2 class="text-2xl font-bold mb-6 text-gray-700">训练项目</h2>
                <div id="exercise-list" class="space-y-6">
                    <!-- JS will generate exercises here -->
                </div>
            </div>

            <!-- Daily Log -->
            <div class="m3-surface p-6">
                <h2 class="text-2xl font-bold mb-6 text-gray-700">每日记录</h2>
                <div class="space-y-4">
                    <div>
                        <label for="photo-upload" class="font-bold text-gray-600">上传今日照片</label>
                        <input type="file" id="photo-upload" accept="image/*" class="mt-1 block w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-blue-100 file:text-blue-700 hover:file:bg-blue-200">
                        <img id="image-preview" src="" class="mt-4 rounded-xl max-h-60 hidden" alt="图片预览"/>
                    </div>
                    <div>
                        <label for="notes" class="font-bold text-gray-600">今日感想</label>
                        <textarea id="notes" rows="4" class="mt-1 w-full px-4 py-3 border-2 border-gray-200 rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-blue-500 outline-none transition" placeholder="记录一下今天的感受，或者任何想说的话..."></textarea>
                    </div>
                </div>
            </div>
            
            <!-- Save Button -->
            <div class="text-center">
                 <button id="save-progress" class="m3-button text-lg px-8 py-4">
                    <span class="material-symbols-outlined">save</span>
                    保存今日所有进度
                </button>
                <p id="save-status" class="mt-4 h-6 text-green-600 font-bold"></p>
            </div>
        </main>
    </div>

    <!-- Firebase SDKs -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, setDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { getStorage, ref, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-storage.js";

        // Firebase Config
        const firebaseConfig = {
            apiKey: "AIzaSyC7XJuqUZrNbnuWZMIn3XBBctIYDwsZ4kE",
            authDomain: "my-abs-tracker-0.firebaseapp.com",
            projectId: "my-abs-tracker-0",
            storageBucket: "my-abs-tracker-0.firebasestorage.app",
            messagingSenderId: "799705014883",
            appId: "1:799705014883:web:3d340de1088848cb3f8e56",
            measurementId: "G-KWTCEWNW1Q"
        };
        
        // Init Firebase
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const storage = getStorage(app);
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'my-abs-tracker-0';

        let userId = null;
        let todayLog = { exercises: {} };

        // Exercises Definition
        const exercises = {
            'plank': { name: '平板支撑', totalSets: 4, unit: '分钟', reps: 1, icon: 'exercise' },
            'crunches': { name: '摸膝卷腹', totalSets: 4, unit: '次', reps: 20, icon: 'fitness_center' },
            'bicycle': { name: '仰卧蹬车', totalSets: 4, unit: '次', reps: 20, icon: 'directions_bike' },
            'twists': { name: '俄罗斯转体', totalSets: 4, unit: '次', reps: 18, icon: 'sync_alt' },
            'stretch': { name: '腹肌拉伸', totalSets: 1, unit: '秒', reps: 60, icon: 'self_improvement' }
        };

        // Get today's date string YYYY-MM-DD
        function getTodayString() {
            const today = new Date();
            const yyyy = today.getFullYear();
            const mm = String(today.getMonth() + 1).padStart(2, '0');
            const dd = String(today.getDate()).padStart(2, '0');
            return `${yyyy}-${mm}-${dd}`;
        }

        // Render exercise list
        function renderExercises() {
            const container = document.getElementById('exercise-list');
            container.innerHTML = '';
            for (const key in exercises) {
                const ex = exercises[key];
                const completedSets = todayLog.exercises[key] || 0;
                
                let setButtons = '';
                for(let i = 1; i <= ex.totalSets; i++) {
                    setButtons += `<button class="set-button ${i <= completedSets ? 'completed' : ''}" data-exercise="${key}" data-set="${i}">${i}</button>`;
                }

                const item = `
                    <div class="flex items-center gap-4 p-4 bg-blue-50 rounded-3xl">
                        <div class="p-3 m3-primary-bg rounded-full">
                            <span class="material-symbols-outlined m3-primary-text">${ex.icon}</span>
                        </div>
                        <div class="flex-grow">
                            <p class="font-bold text-lg text-gray-800">${ex.name}</p>
                            <p class="text-sm text-gray-500">${ex.totalSets} 组 x ${ex.reps} ${ex.unit}</p>
                        </div>
                        <div class="flex gap-2 flex-wrap justify-end">
                            ${setButtons}
                        </div>
                    </div>
                `;
                container.innerHTML += item;
            }
            addSetButtonListeners();
        }

        function addSetButtonListeners() {
            document.querySelectorAll('.set-button').forEach(button => {
                button.addEventListener('click', () => {
                    const exKey = button.dataset.exercise;
                    const setNum = parseInt(button.dataset.set);
                    
                    // Toggle logic
                    if (todayLog.exercises[exKey] === setNum) { // If clicking the last completed set
                        todayLog.exercises[exKey] = setNum - 1; // Un-complete it
                    } else {
                        todayLog.exercises[exKey] = setNum; // Complete up to this set
                    }
                    
                    renderExercises(); // Re-render to update UI
                });
            });
        }
        
        async function loadTodayData() {
            const todayStr = getTodayString();
            const docRef = doc(db, `artifacts/${appId}/public/data/workout_logs`, todayStr);
            const docSnap = await getDoc(docRef);

            if (docSnap.exists()) {
                todayLog = docSnap.data();
                if (!todayLog.exercises) todayLog.exercises = {};
                document.getElementById('notes').value = todayLog.notes || '';
                if (todayLog.photoUrl) {
                    const preview = document.getElementById('image-preview');
                    preview.src = todayLog.photoUrl;
                    preview.classList.remove('hidden');
                }
            }
            renderExercises();
        }

        async function saveData() {
            const saveButton = document.getElementById('save-progress');
            const saveStatus = document.getElementById('save-status');
            saveButton.disabled = true;
            saveStatus.textContent = '正在保存...';

            try {
                const todayStr = getTodayString();
                const fileInput = document.getElementById('photo-upload');
                const file = fileInput.files[0];
                
                // 1. Upload photo if exists
                if (file) {
                    const storageRef = ref(storage, `images/${todayStr}-${file.name}`);
                    await uploadBytes(storageRef, file);
                    todayLog.photoUrl = await getDownloadURL(storageRef);
                    // Update preview immediately
                    const preview = document.getElementById('image-preview');
                    preview.src = todayLog.photoUrl;
                    preview.classList.remove('hidden');
                }

                // 2. Prepare data object
                todayLog.notes = document.getElementById('notes').value;
                todayLog.date = new Date(); // Update timestamp

                // 3. Save to Firestore
                const docRef = doc(db, `artifacts/${appId}/public/data/workout_logs`, todayStr);
                await setDoc(docRef, todayLog, { merge: true });

                saveStatus.textContent = '✅ 保存成功！';

            } catch (error) {
                console.error("保存失败: ", error);
                saveStatus.textContent = `❌ 保存失败: ${error.message}`;
            } finally {
                setTimeout(() => {
                    saveButton.disabled = false;
                    saveStatus.textContent = '';
                }, 3000);
            }
        }
        
        // Password check
        function handlePassword() {
            const correctPass = "Aa136789@";
            const passInput = document.getElementById('password-input');
            const passSubmit = document.getElementById('password-submit');
            const passError = document.getElementById('password-error');
            const modal = document.getElementById('password-modal');
            const content = document.getElementById('app-content');

            const check = () => {
                if (passInput.value === correctPass) {
                    modal.style.display = 'none';
                    content.classList.remove('hidden');
                    initializeAppLogic();
                } else {
                    passError.textContent = '密码错误，请重试。';
                    passInput.classList.add('border-red-500');
                }
            };
            
            passSubmit.addEventListener('click', check);
            passInput.addEventListener('keyup', (e) => {
                if (e.key === 'Enter') check();
            });
        }

        function initializeAppLogic() {
            document.getElementById('today-date').textContent = new Date().toLocaleDateString('zh-CN', { dateStyle: 'long' });

            // Auth state listener
            onAuthStateChanged(auth, (user) => {
                if (user) {
                    userId = user.uid;
                    loadTodayData(); // Load data after user is confirmed
                } else {
                    signInAnonymously(auth).catch((error) => {
                        console.error("匿名登录失败", error);
                    });
                }
            });

            // Event Listeners
            document.getElementById('save-progress').addEventListener('click', saveData);
            document.getElementById('photo-upload').addEventListener('change', (event) => {
                const file = event.target.files[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onload = (e) => {
                        const preview = document.getElementById('image-preview');
                        preview.src = e.target.result;
                        preview.classList.remove('hidden');
                    }
                    reader.readAsDataURL(file);
                }
            });
        }

        // Run on page load
        window.onload = () => {
            handlePassword();
        };

    </script>
</body>
</html>
